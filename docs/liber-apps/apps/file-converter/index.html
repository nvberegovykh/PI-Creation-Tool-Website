<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>File Converter</title>
  <link rel="stylesheet" href="../../css/style.css" />
  <style>
    body{background:var(--primary-bg,#000);color:var(--primary-text,#eaeaea);font-family:var(--app-font,"Courier Prime","Courier New","Lucida Console",monospace)}
    .wrap{max-width:900px;margin:0 auto;padding:16px;padding-top:max(16px,env(safe-area-inset-top))}
    .panel{border:1px solid var(--border-color,#2b2f38);border-radius:12px;padding:16px;background:var(--secondary-bg,#0e1014);margin:12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .row>*>*{max-width:100%}
    label{display:block;margin-bottom:6px;opacity:.9}
    select,button,input{background:#161a22;border:1px solid #2b2f38;color:#fff;border-radius:8px;padding:10px}
    .out{white-space:pre-wrap;background:#0b0e12;border-radius:8px;padding:12px;border:1px dashed #2b2f38}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <h2>File Converter</h2>
      <button id="back-to-cp" style="background:#1b2330;border:1px solid #2b2f38;color:#fff;border-radius:8px;padding:8px 12px">Back to Control Panel</button>
    </div>
    <div class="panel">
      <div class="row">
        <div style="flex:1 1 260px">
          <label for="file-input">Select file</label>
          <input id="file-input" type="file" />
        </div>
        <div style="flex:1 1 180px">
          <label for="type-select">Type</label>
          <select id="type-select">
            <option value="auto">Auto-detect</option>
            <option value="image">Image</option>
            <option value="audio">Audio</option>
            <option value="video">Video</option>
          </select>
        </div>
        <div style="flex:1 1 200px">
          <label for="format-select">Target format</label>
          <select id="format-select">
            <optgroup label="Image">
              <option value="png">PNG</option>
              <option value="jpg">JPG</option>
              <option value="webp">WEBP</option>
              <option value="bmp">BMP</option>
              <option value="tiff">TIFF</option>
              <option value="gif">GIF</option>
              <option value="ico">ICO</option>
              <option value="svg">SVG (vectorize)</option>
              <option value="pdf">PDF (single page)</option>
            </optgroup>
            <optgroup label="Audio">
              <option value="wav">WAV</option>
              <option value="mp3">MP3</option>
              <option value="ogg">OGG</option>
              <option value="flac">FLAC</option>
              <option value="aac">AAC</option>
              <option value="m4a">M4A</option>
            </optgroup>
            <optgroup label="Video">
              <option value="mp4">MP4 (H.264/AAC)</option>
              <option value="webm">WEBM (VP9/Opus)</option>
              <option value="avi">AVI</option>
              <option value="mov">MOV</option>
              <option value="mkv">MKV</option>
              <option value="gifv">GIFV</option>
            </optgroup>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="convert-btn">Convert</button>
        </div>
      </div>
      <div id="progress" style="margin-top:12px;opacity:.9"></div>
      <div id="output" class="out" style="margin-top:12px"></div>
    </div>
    <p style="opacity:.7">Powered by ffmpeg.wasm (client-side). Some conversions may be CPU intensive on mobile.</p>
  </div>

  <script>
    // Resilient ffmpeg loader with awaitable ready function
    (function(){
      const add=(u)=>{const s=document.createElement('script');s.src=u;s.async=true;s.onerror=()=>{};document.head.appendChild(s)};
      if (!window.FFmpeg){
        add('https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js');
        add('https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js');
      }
      // Vectorizer for SVG output
      if (!window.ImageTracer){
        add('https://unpkg.com/imagetracerjs@1.2.6/imagetracer_v1.2.6.js');
      }
      window.waitForFFmpeg = function waitForFFmpeg(){
        return new Promise(resolve=>{
          let tries = 0;
          const tick = ()=>{
            if (window.FFmpeg && window.FFmpeg.createFFmpeg){ return resolve(window.FFmpeg); }
            if (tries++ > 120){ return resolve(null); }
            setTimeout(tick, 100);
          };
          tick();
        });
      };
    })();
  </script>
  <script>
    // Back button logic: focus existing dashboard tab if opened from it; else navigate
    (function(){
      const back = document.getElementById('back-to-cp');
      if (back){
        back.addEventListener('click', (e)=>{
          e.preventDefault();
          try{
            if (window.opener && !window.opener.closed){ try{ window.opener.focus(); }catch(_){} try{ window.close(); }catch(_){} return; }
          }catch(_){ }
          window.location.href='../../index.html#apps';
        });
      }
    })();

    let ffmpeg;
    const el = (id)=> document.getElementById(id);

    const detectType = (file)=>{
      const t = (file.type||'').toLowerCase();
      if (t.startsWith('image/')) return 'image';
      if (t.startsWith('audio/')) return 'audio';
      if (t.startsWith('video/')) return 'video';
      return 'auto';
    };

    async function ensureFFmpeg(){
      if (!ffmpeg){
        const mod = await window.waitForFFmpeg();
        if (!mod){ throw new Error('FFmpeg failed to load'); }
        const { createFFmpeg } = mod;
        const candidates = [
          'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js',
          'https://unpkg.com/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js',
          'https://unpkg.com/@ffmpeg/core@0.11.1/dist/ffmpeg-core.js'
        ];
        let lastErr = null;
        for (const corePath of candidates){
          try{
            const inst = createFFmpeg({ log: true, corePath });
            el('progress').textContent = 'Loading FFmpeg...';
            await inst.load();
            ffmpeg = inst; lastErr = null; break;
          }catch(e){ lastErr = e; }
        }
        if (!ffmpeg){
          throw lastErr || new Error('FFmpeg failed to load');
        }
      } else if (!ffmpeg.isLoaded()) {
        el('progress').textContent = 'Loading converter...';
        await ffmpeg.load();
      }
    }

    function downloadBlob(blob, name){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 5000); }

    document.getElementById('convert-btn').onclick = async()=>{
      const input = el('file-input').files[0];
      if (!input){ alert('Choose a file'); return; }
      const kind = (el('type-select').value==='auto') ? detectType(input) : el('type-select').value;
      const target = el('format-select').value;
      const inName = 'input.' + (input.name.split('.').pop()||'dat');
      const outName = 'output.' + target;
      try{
        await ensureFFmpeg();
        el('progress').textContent = 'Running conversion...';
        const { fetchFile } = window.FFmpeg;
        // Special handling for SVG vector output without ffmpeg
        if (kind==='image' && target==='svg'){
          el('progress').textContent = 'Vectorizing to SVG...';
          const blobUrl = URL.createObjectURL(input);
          const img = new Image();
          img.onload = ()=>{
            try{
              const canvas = document.createElement('canvas');
              canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0);
              const imdata = ctx.getImageData(0, 0, canvas.width, canvas.height);
              const svgstr = (window.ImageTracer && ImageTracer.imagedataToSVG) ? ImageTracer.imagedataToSVG(imdata, { ltres:1, qtres:1, pathomit:8 }) : null;
              if (!svgstr) throw new Error('SVG vectorizer unavailable');
              const blob = new Blob([svgstr], { type:'image/svg+xml' });
              downloadBlob(blob, outName);
              el('output').textContent = 'Done: ' + outName;
              el('progress').textContent = '';
            }catch(e){ el('progress').textContent = 'Conversion failed'; el('output').textContent = e.message; }
            finally{ URL.revokeObjectURL(blobUrl); }
          };
          img.onerror = ()=>{ el('progress').textContent='Conversion failed'; el('output').textContent='Could not load image'; };
          img.src = blobUrl;
          return;
        }

        ffmpeg.FS('writeFile', inName, await fetchFile(input));
        let args = [];
        if (kind==='image'){
          if (target==='pdf') { args = ['-i', inName, '-vf', 'scale=1200:-1', '-f', 'pdf', outName]; }
          else { args = ['-i', inName, outName]; }
        } else if (kind==='audio'){
          if (target==='mp3') args = ['-i', inName, '-b:a', '192k', outName];
          else if (target==='aac' || target==='m4a') args = ['-i', inName, '-c:a', 'aac', '-b:a','192k', outName];
          else if (target==='flac') args = ['-i', inName, '-c:a','flac', outName];
          else args = ['-i', inName, outName];
        } else if (kind==='video'){
          if (target==='mp4') args = ['-i', inName, '-c:v', 'libx264', '-preset', 'veryfast', '-c:a', 'aac', outName];
          else if (target==='webm') args = ['-i', inName, '-c:v', 'libvpx-vp9', '-b:v', '0', '-crf', '30', '-c:a', 'libopus', outName];
          else if (target==='avi') args = ['-i', inName, '-c:v', 'mpeg4', '-qscale:v', '3', '-c:a', 'mp2', outName];
          else if (target==='gifv' || target==='gif') args = ['-i', inName, '-vf','fps=12,scale=640:-1:flags=lanczos', outName==='gifv'? 'out.gif': outName];
          else args = ['-i', inName, outName];
        } else { args = ['-i', inName, outName]; }
        await ffmpeg.run(...args);
        const data = ffmpeg.FS('readFile', outName);
        const blob = new Blob([data.buffer], { type: (kind==='image' ? 'image/'+target : (kind==='audio' ? 'audio/'+target : 'video/'+target))});
        downloadBlob(blob, outName);
        el('output').textContent = 'Done: ' + outName + ' (' + (blob.size/1024).toFixed(1) + ' KB)';
        el('progress').textContent = '';
      }catch(e){
        console.error(e); el('progress').textContent = 'Conversion failed';
        el('output').textContent = (e && e.message) || String(e);
      }
    };
  </script>
</body>
</html>


