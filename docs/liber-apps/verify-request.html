<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verify & Log In - Liber Apps</title>
  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/auth.css" />
  <style>
    .verify-container { max-width: 420px; margin: 48px auto; padding: 24px; text-align: center; }
    .verify-spinner { width: 40px; height: 40px; margin: 0 auto 16px; border: 3px solid var(--border-color, #283246); border-top-color: #3b82f6; border-radius: 50%; animation: verify-spin 0.8s linear infinite; }
    @keyframes verify-spin { to { transform: rotate(360deg); } }
    .verify-error { color: #dc2626; }
    .verify-success { color: #22c55e; }
    .verify-link { display: inline-block; margin-top: 16px; color: #3b82f6; }
  </style>
</head>
<body>
  <div class="verify-container">
    <div id="verify-loading">
      <div class="verify-spinner"></div>
      <p>Verifying and signing you in...</p>
    </div>
    <div id="verify-error" style="display:none" class="verify-error">
      <p id="verify-error-msg"></p>
      <a href="index.html" class="verify-link">Go to Login</a>
    </div>
    <div id="verify-success" style="display:none" class="verify-success">
      <p>You're in! Redirecting to Project Tracker...</p>
    </div>
  </div>

  <script type="module" src="js/firebase-loader.js"></script>
  <script src="js/secure-keys.js"></script>
  <script src="js/firebase-service.js"></script>
  <script>
    (function(){
      const loading = document.getElementById('verify-loading');
      const errDiv = document.getElementById('verify-error');
      const errMsg = document.getElementById('verify-error-msg');
      const successDiv = document.getElementById('verify-success');

      function showError(msg){
        loading.style.display = 'none';
        errDiv.style.display = '';
        errMsg.textContent = msg || 'Verification failed. The link may have expired.';
      }

      function showSuccess(){
        loading.style.display = 'none';
        successDiv.style.display = '';
      }

      async function run(){
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');
        if (!token){
          showError('Invalid link. No verification token found.');
          return;
        }

        try {
          let attempts = 0;
          while ((!window.firebase || !window.firebaseService?.isInitialized) && attempts < 50){
            await new Promise(r => setTimeout(r, 200));
            attempts++;
          }

          const fs = window.firebaseService;
          if (fs?.auth) {
            try { await firebase.signOut(fs.auth); } catch (_) {}
          }
          const firebaseProjectId = (fs?.app?.options?.projectId) || 'liber-apps-cca20';
          const region = (fs?.functionsByRegion && Object.keys(fs.functionsByRegion)[0]) || 'europe-west1';
          const verifyUrl = `https://${region}-${firebaseProjectId}.cloudfunctions.net/verifyRequestTokenHttp`;

          let data = null;
          try {
            const httpRes = await fetch(verifyUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token })
            });
            const json = await httpRes.json().catch(() => ({}));
            if (httpRes.ok) data = json;
            else throw new Error(json?.error || 'Verification failed');
          } catch (httpErr) {
            if (fs?.callFunction) {
              const result = await fs.callFunction('verifyRequestToken', { token });
              data = result?.data ?? result;
            } else {
              throw httpErr;
            }
          }

          const customToken = data?.customToken;

          if (!customToken){
            showError(data?.message || 'Verification failed.');
            return;
          }

          const user = await firebase.signInWithCustomToken(fs.auth, customToken);
          if (user?.user){
            showSuccess();
            const base = window.location.pathname.replace(/[^/]*$/, '');
            const fullUrl = window.location.origin + base + 'index.html#apps';
            sessionStorage.setItem('liber_launch_after_verify', 'project-tracker');
            const launchProjectId = data?.projectId || null;
            if (launchProjectId) sessionStorage.setItem('liber_verify_project_id', launchProjectId);
            setTimeout(function(){
              window.location.href = fullUrl;
            }, 800);
          } else {
            showError('Sign-in failed.');
          }
        } catch (e){
          console.error('Verify error', e);
          showError(e?.message || 'Verification failed. The link may have expired.');
        }
      }

      if (document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', run);
      } else {
        run();
      }
    })();
  </script>
</body>
</html>
